services:
    autoscaling:
        deploy:
            replicas: 0
    agent:
        volumes:
            - /docker/volumes/:/docker/volumes/
    postgres:
        deploy:
            placement:
                constraints:
                    - node.labels.postgres == true
    dask-sidecar:
        deploy:
            placement:
                constraints:
                    - node.role == worker

    traefik:
        environment:
            TRAEFIK_ENTRYPOINTS_POSTGRES_ADDRESS: ":5432"
        deploy:
            resources:
                limits:
                    memory: 2048M
                    cpus: "2.000"
            labels:
                - traefik.tcp.routers.${SWARM_STACK_NAME}_postgresRoute.entrypoints=postgres
                - traefik.tcp.routers.${SWARM_STACK_NAME}_postgresRoute.tls=false
                - traefik.tcp.routers.${SWARM_STACK_NAME}_postgresRoute.service=${SWARM_STACK_NAME}_postgresRoute
                - traefik.tcp.services.${SWARM_STACK_NAME}_postgresRoute.loadbalancer.server.port=5432
                - "traefik.tcp.routers.${SWARM_STACK_NAME}_postgresRoute.rule=ClientIP(`195.176.8.0/24`) || ClientIP(`10.0.0.0/8`) || ClientIP(`172.16.0.0/12`) || ClientIP(`192.168.0.0/16`)"
    wb-garbage-collector:
        hostname: "{{.Service.Name}}"
    wb-api-server:
        deploy:
            replicas: 3
    clusters-keeper:
        deploy:
            replicas: 0
    payments:
        deploy:
            replicas: 0
    rabbit:
        deploy:
            replicas: 0  # use standalone (cluster) rabbit stack
