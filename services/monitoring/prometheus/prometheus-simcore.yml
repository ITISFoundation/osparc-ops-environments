scrape_configs:
  # SIMCORE -------------------------------------------------------------------
  - job_name: "simcore"
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__meta_dns_name]
        separator: ;
        regex: ^(.*\.)?(.*?)[_-].*$
        target_label: deployment
        replacement: $2
        action: replace
      - source_labels: [__meta_dns_name]
        separator: ;
        regex: ^.*?[_-](.*)$
        target_label: service_name
        replacement: $1
        action: replace
    # Handle with "tasks." when there are multiple replica according to https://www.innoq.com/en/blog/scraping-docker-swarm-service-instances-with-prometheus/
    dns_sd_configs:
      - names:
          - "tasks.production_agent"
          - "tasks.staging_agent"
          - "tasks.master_agent"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_api-server"
          - "tasks.staging_api-server"
          - "tasks.master_api-server"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_autoscaling"
          - "tasks.staging_autoscaling"
          - "tasks.master_autoscaling"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_catalog"
          - "tasks.staging_catalog"
          - "tasks.master_catalog"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_clusters-keeper"
          - "tasks.staging_clusters-keeper"
          - "tasks.master_clusters-keeper"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_datcore-adapter"
          - "tasks.staging_datcore-adapter"
          - "tasks.master_datcore-adapter"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_director"
          - "tasks.staging_director"
          - "tasks.master_director"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_director-v2"
          - "tasks.staging_director-v2"
          - "tasks.master_director-v2"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_dynamic-schdlr"
          - "tasks.staging_dynamic-schdlr"
          - "tasks.master_dynamic-schdlr"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_invitations"
          - "tasks.staging_invitations"
          - "tasks.master_invitations"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_payments"
          - "tasks.staging_payments"
          - "tasks.master_payments"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_resource-usage-tracker"
          - "tasks.staging_resource-usage-tracker"
          - "tasks.master_resource-usage-tracker"
        type: "A"
        port: 8000
      - names:
          - "tasks.production_rabbit"
          - "tasks.staging_rabbit"
          - "tasks.master_rabbit"
        type: "A"
        port: 15692
      - names:
          - "tasks.production_storage"
          - "tasks.staging_storage"
          - "tasks.master_storage"
        type: "A"
        port: 8080
      - names:
          - "tasks.production_traefik"
          - "tasks.staging_traefik"
          - "tasks.master_traefik"
        type: "A"
        port: 8082
      - names:
          - "tasks.production_webserver"
          - "tasks.staging_webserver"
          - "tasks.master_webserver"
        type: "A"
        port: 8080
      - names:
          - "tasks.production_wb-api-server"
          - "tasks.staging_wb-api-server"
          - "tasks.master_wb-api-server"
        type: "A"
        port: 8080
      - names:
          - "tasks.master-redis-exporter"
          - "tasks.staging-redis-exporter"
          - "tasks.production-redis-exporter"
        type: "A"
        port: 9121
      - names:
          - "tasks.master-postgres-exporter"
          - "tasks.staging-postgres-exporter"
          - "tasks.production-postgres-exporter"
        type: "A"
        port: 9187
      - names:
          - "tasks.dcgm-exporter"
        type: "A"
        port: 9400
      - names:
          - "tasks.pgsql-query-exporter"
        type: "A"
        port: 9560
      - names:
          - "tasks.master_dask-scheduler"
          - "tasks.staging_dask-scheduler"
          - "tasks.production_dask-scheduler"
        type: "A"
        port: 8787
      - names:
          - "tasks.master_dask-sidecar"
          - "tasks.staging_dask-sidecar"
          - "tasks.production_dask-sidecar"
        type: "A"
        port: 8787
