
{{ $globalScope := . }}
{{- range $dashboardFilePath, $_ := .Files.Glob  "files/dashboards/**.json" -}}
{{ with $globalScope }}

{{- $dashboardFileName := base $dashboardFilePath }}
{{- $dashboardName := (trimSuffix (ext $dashboardFileName) $dashboardFileName) | replace "_" "-" -}}
{{- $dashboardFolder := dir (trimPrefix "files/dashboards/" $dashboardFilePath) -}}

{{- if ne $dashboardFolder (base $dashboardFolder) -}}
{{- fail (printf "nested folders are not supported for dashboards (see https://github.com/grafana/grafana/issues/107158): %s" (trimPrefix "files/dashboards/" $dashboardFilePath)) -}}
{{- end -}}

---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ $dashboardName }}-grafana-dashboard
  labels:
    # TODO: add reusable common labels
    {{ .Values.grafanaDashboardLabel }}: {{ .Values.grafanaDashboardLabelValue }}
  annotations:
    # nested folders are not supported <https://github.com/grafana/grafana/issues/107158
    dashboard_folder: "{{ $dashboardFolder }}"
data:
  {{ $dashboardName }}.json: | {{ tpl (.Files.Get $dashboardFilePath) . | nindent 4 }}

{{- end }}
{{- end }}
